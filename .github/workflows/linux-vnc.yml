# Reverse Linux VNC for GitHub Actions
# This YAML establishes the "build" workflow where we will execute all required scripts
# During the process, it should get stuck at the last step where it creates a new tunnel on ngrok.

name: Ubuntu
on: [workflow_dispatch]
defaults:
  run:
    shell: bash
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Preparing environment...
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
          VNC_PASSWORD: ${{ secrets.VNC_PASSWORD }}
        # legacy run command script-- run: ./scripts/configure-legacy.sh
        run: ./scripts/configure.sh

      - name: Start background timer for 5h59m (non-blocking)
        env:
          VNC_PASSWORD: ${{ secrets.VNC_PASSWORD }}
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        # Start a background process that sleeps for 5h59m (21540s) and then runs the delayed-action script.
        # Use nohup so it survives the step termination; the job itself remains alive because ngrok is started later.
        run: |
          echo "Starting non-blocking background timer for 5h59m (21540 seconds)"
          chmod +x ./scripts/delayed-action.sh
          nohup bash -lc 'sleep 21540 && bash "${GITHUB_WORKSPACE}/scripts/delayed-action.sh"' >/dev/null 2>&1 &

      - name: Starting VNC Server...
        env:
          VNC_SCREENSIZE: ${{ secrets.VNC_SCREENSIZE }}
          VNC_DEPTHVALUE: ${{ secrets.VNC_DEPTHVALUE }}
        # legacy run command-- run: cd $HOME && vncserver :1 -geometry $VNC_SCREENSIZE -depth $VNC_DEPTHVALUE -rfbport 7582
        run: export PATH=$PATH:/opt/TurboVNC/bin && cd $HOME && vncserver :1 -geometry $VNC_SCREENSIZE -depth $VNC_DEPTHVALUE -rfbport 7582

      - name: Setting up Rustdesk
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
          VNC_PASSWORD: ${{ secrets.VNC_PASSWORD }}
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: bash scripts/setup-rustdesk.sh

      - name: Start tunnel with ngrok...
        run: ./ngrok tcp 7582
